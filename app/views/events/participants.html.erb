<%- model_class = Event -%>
<div class="page-header">
  <h1><%=t '.title', :default => model_class.model_name.human.titleize %> (<%= @event.kind.humanize %>)</h1>
</div>
<% if can? :view_participants, Event %>
  <%= render :partial => 'participants_modal' %>
  <%= render :partial => 'show_event' %>

  <h1><%= t '.participants' %></h1>
  <%= form_tag(event_path(@event) + "/participants/agreement_letters") do %>
    <table class="table table-striped">
      <tr>
        <th><%= t 'activerecord.attributes.profile.name' %></th>
        <th><%= t 'activerecord.attributes.profile.email' %></th>
        <th><%= t 'agreement_letters.agreement_letter' %></th>
        <% if can? :print_agreement_letters, Event and @has_agreement_letters %>
          <th>
            <label>
              <input type="checkbox" id="select_all_participants" class="participant_selection" onclick="flipAllCheckboxes(this)">
              <%= t 'events.agreement_letters_download.select_all' %>
            </label>
          </th>
        <% end %>
        <% if can? :show_eatings_habits, Event %>
          <th>
            <%= sort_caret(t('activerecord.methods.application_letter.eating_habits'), 'eating-habits') %>
          </th>
        <% end %>
      </tr>

      <% @participants.each do |participant| 
          application_letter = ApplicationLetter.find_by(user_id: participant.id, event_id: @event.id) %>
      <tr>

        <td>
        <%= participant.name %>
        </td>
        <td>
        <%= participant.email %>
        </td>
        <td>
          <% if participant.requires_agreement_letter_for_event?(@event) %>
            <span class="text-muted"> <%= t '.unnecessary' %> </span>
          <% elsif participant.agreement_letter_for_event?(@event) %>
            <span class="text-success" title="<%= participant.agreement_letter_for_event(@event).updated_at %>"> <%= t '.available' %> </span>
          <% else %>
            <span class="text-danger"><%= t '.unavailable' %></span>
          <% end %>
        </td>
        <% if can? :print_agreement_letters, Event and @has_agreement_letters %>
          <td>
            <%= check_box_tag('selected_participants[]', participant.id, false, class: 'participant_selection') %>
          </td>
        <% end %>
        



        <% if can? :show_eatings_habits, Event %>
          <td>
           <% if application_letter.vegan || application_letter.vegetarian || application_letter.allergic %>
             <ul id="eating-habit--list">
             <% if application_letter.vegan %>
               <li>
                 <img 
                   class="img img-responsive eating-habit--icon"
                   src="<%= image_url('application_letter_vegan.png') %>"
                 >
               </li>
             <% end %>                
             <% if application_letter.vegetarian %>
               <li>
                 <img 
                   class="img img-responsive eating-habit--icon"
                   src="<%= image_url('application_letter_vegetarian.png') %>"
                 >
               </li>
             <% end %>
             <% if application_letter.allergic %>
               <li>
                 <%= image_tag('application_letter_allergic.png',
                                  class: "img img-responsive eating-habit--icon has-popover",
                                  tabindex: 50,
                                  data: { 
                                    toggle: "popover", 
                                    content: application_letter.allergies, 
                                    placement: "bottom" 
                                    }) 
                  %>
               </li>
             <% end %>
           </ul>
           <% end %> 




          </td>
        <% end %>
      </tr>
      <% end %>
    </table>

    <button class="btn btn-default" type="button" data-toggle="modal" data-target="#print_participant_modal" id="open_print_modal">Teilnehmerliste (PDF)</button>
    <% if can? :print_agreement_letters, Event and @has_agreement_letters %>
      <div id="participants_download_submit_button">
      <%= submit_tag t('events.agreement_letters_download.download_all_as'), name: "download_all", class: "btn btn-default" %>
      <%= select_tag :download_type, options_for_select([['pdf'], ['zip']]) %>
      </div>
    <% end %>
  <% end %>
  <div class="row spacer-15"></div>
  <div class="row">
    <div class="btn-group" role="group">
      <% if can? :print_applications_eating_habits, Event %>
        <%= link_to t('application_letters.print_accepted_with_eatings_habits'),
          print_applications_eating_habits_event_path(@event.id), :target => "_blank", :class => 'btn btn-default'%>
      <% end %>
      <%= link_to t('.back', :default => t('helpers.links.back')),
                  event_path(@event), :class => 'btn btn-default'  %>      
    </div>
  </div>       
<% end %>
